/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function Submitter(a,b,c,d,e){"use strict";function f(a,b,c,d,e){D.resources||(D.resources=[]);var f=n(a,b),i=g(a.buffer,f,c,d,e);D.resources.push(i),z+=i.data.body.byteLength,b.parentNode.replaceChild(h(a.buffer,f,b),b)}function g(a,b,c,d,e){var f=new Resource;if(f.data=new Data,f.data.body=a,f.mime=b,f.attributes=new ResourceAttributes,f.attributes.sourceURL=GlobalUtils.removeControlCharacters(c),f.attributes.fileName=d,!d&&c){var g=/.+\/(.+?)(?:$|\?)/.exec(c);if(g)try{f.attributes.fileName=decodeURIComponent(g[1])}catch(h){if("URIError"!==h.name)throw h;f.attributes.fileName=unescape(g[1])}}return f.attributes.fileName&&!l(f.attributes.fileName,b)&&(f.attributes.fileName+=m(b)),f.attributes.fileName&&(f.attributes.fileName=GlobalUtils.removeControlCharacters(f.attributes.fileName)),f.attributes.attachment=!!e,f}function h(a,b,c){var d=E.createElement("en-media");d.setAttribute("type",b),d.setAttribute("hash",SparkMD5.ArrayBuffer.hash(a));for(var e=0;e<c.attributes.length;e++){var f=c.attributes[e].name.toLowerCase();I.indexOf(f)>-1&&d.setAttribute(f,c.attributes[e].value)}return d}function i(a,b,c,d,e,f,g,h,i,j,k){D.attributes=new NoteAttributes,D.attributes.source="clearly"===i?"Clearly":"web.clip",D.attributes.sourceURL=GlobalUtils.removeControlCharacters(h),D.content='<?xml version="1.0" encoding="utf-8"?><!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd"><en-note>',g&&g.trim()&&(D.content+=GlobalUtils.escapeXML(g)+"<hr/>"),D.content+="<br/>"+j+"<br/></en-note>";var l=new DOMParser;E=l.parseFromString(GlobalUtils.removeControlCharacters(D.content,!0),"application/xml");for(var m=E.querySelectorAll("img[src], embed[src], div[evernote_attachment_url]"),n=0;n<m.length;n++){var o=m[n],h=o.getAttribute("src")||o.getAttribute("evernote_attachment_url");h&&(G.test(h)?p(G.exec(h)[1],o):H.test(h)?r(k[H.exec(h)[1]-0],o):q(h,o))}D.title=a,D.notebookGuid=b,w=c,x=d,y=e,f&&f.length>0&&(D.tagNames=f),A=!0,t()}function j(b){var c;switch(b.name){case"EDAMNotFoundException":"Note.notebookGuid"==b.identifier&&(c="unknownNotebook");break;case"EDAMUserException":switch(b.errorCode){case EDAMErrorCode.BAD_DATA_FORMAT:switch(b.parameter){case"Note.content":c="noteSizeExceeded"}break;case EDAMErrorCode.LIMIT_REACHED:switch(b.parameter){case"Note":c="overAccountMax";break;case"Note.size":c="noteSizeExceeded";break;case"Note.resources":c="noteSizeExceeded";break;case"Resource.data.size":c="noteSizeExceeded"}break;case EDAMErrorCode.QUOTA_REACHED:"Accounting.uploadLimit"==b.parameter&&(c="overQuota")}}c||log.error(D.attributes.sourceURL+b.__proto__.name+JSON.stringify(b)),extension.trackEvent("noteSizeExceeded"===c?{category:"Errors",action:"Too big",label:D.attributes.sourceURL}:"overQuota"===c?{category:"Errors",action:"Over quota",label:D.attributes.sourceURL}:"overAccountMax"===c?{category:"Errors",action:"Over account max",label:D.attributes.sourceURL}:{category:"Errors",action:"Thrift: "+JSON.stringify(b).substr(0,200),label:D.attributes.sourceURL}),e({name:"fail",error:c,tokens:a})}function k(b){function c(){var c={name:"success",noteSize:z,noteGuid:b.guid,shardId:/^"?S=([^:]+)/.exec(F)[1],notebookName:w,noShareNotes:x,tokens:a,userIds:d,notebookType:y};!c.notebookName||c.noShareNotes!==!0&&c.noShareNotes!==!1?u.getNotebook(F,b.notebookGuid,function(a){c.notebookName=a.name,c.noShareNotes=a.restrictions.noShareNotes,e(c)},function(a){log.error(a.name+" "+JSON.stringify(a)),e(c)}):e(c)}console.log(b),c()}function l(a,b){return b===EDAM_MIME_TYPE_JPEG?/\.jpe?g$/.test(a):b===EDAM_MIME_TYPE_PNG?/\.png$/.test(a):b===EDAM_MIME_TYPE_GIF?/\.gif$/.test(a):b===EDAM_MIME_TYPE_PDF?/\.pdf$/.test(a):"image/webp"===b?/\.webp$/.test(a):!0}function m(a){return a===EDAM_MIME_TYPE_JPEG?".jpg":a===EDAM_MIME_TYPE_PNG?".png":a===EDAM_MIME_TYPE_GIF?".gif":a===EDAM_MIME_TYPE_PDF?".pdf":"image/webp"===a?".webp":""}function n(a,b){if(b&&b.hasAttribute("evernote_attachment_mime")){var c=b.getAttribute("evernote_attachment_mime");if(c.toLowerCase()!==EDAM_MIME_TYPE_DEFAULT&&new RegExp(EDAM_MIME_REGEX).test(c))return c}if(255===a[0]&&216===a[1]&&255===a[2])return EDAM_MIME_TYPE_JPEG;if(137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]&&13===a[4]&&10===a[5]&&26===a[6]&&10===a[7])return EDAM_MIME_TYPE_PNG;if(0===a[0]&&0===a[1]&&1===a[2]&&0===a[3])return EDAM_MIME_TYPE_PNG;if(71===a[0]&&73===a[1]&&70===a[2]&&56===a[3]&&(55===a[4]||57===a[4])&&97===a[5])return EDAM_MIME_TYPE_GIF;if(37===a[0]&&80===a[1]&&68===a[2]&&70===a[3])return EDAM_MIME_TYPE_PDF;if(82===a[0]&&73===a[1]&&70===a[2]&&70===a[3]&&87===a[8]&&69===a[9]&&66===a[10]&&80===a[11])return"image/webp";if(208===a[0]&&207===a[1]&&17===a[2]&&224===a[3]&&161===a[4]&&177===a[5]&&26===a[6]&&225===a[7]){if(236===a[512]&&165===a[513]&&193===a[514]&&0===a[515])return"application/msword";if(0===a[512]&&110===a[513]&&30===a[514]&&240===a[515]||15===a[512]&&0===a[513]&&232===a[514]&&3===a[515]||160===a[512]&&70===a[513]&&29===a[514]&&240===a[515])return"application/mspowerpoint";if(9===a[512]&&8===a[513]&&16===a[514]&&0===a[515]&&0===a[516]&&6===a[517]&&5===a[518]&&0===a[519]||253===a[512]&&255===a[513]&&255===a[514]&&255===a[515]&&32===a[516]&&0===a[517]&&0===a[518]&&0===a[519])return"application/excel"}else if(80===a[0]&&75===a[1]&&3===a[2]&&4===a[3]){var d=OOXMLReader.getFileType(a);if(d===OOXMLReader.DOCX)return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";if(d===OOXMLReader.PPTX)return"application/vnd.openxmlformats-officedocument.presentationml.presentation";if(d===OOXMLReader.XLSX)return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}return EDAM_MIME_TYPE_DEFAULT}function o(){v=/^"?S=(s\d+)/.exec(F)[1];var a=new Thrift.BinaryHttpTransport(c+"/edam/note/"+v),b=new Thrift.BinaryProtocol(a);u=new NoteStoreClient(b)}function p(a,b){for(var c=decodeURIComponent(a).split("&")[0],d=window.atob(c),e=new Uint8Array(2*d.length),g=0;g<d.length;g++)e[g]=d.charCodeAt(g);f(e,b)}function q(a,b){a=GlobalUtils.unescapeXML(a);var c=new XMLHttpRequest;c.open("GET",a),c.responseType="arraybuffer",B++,c.onreadystatechange=function(a,b){return function(){4===this.readyState&&(200===this.status&&this.response&&this.response.byteLength>0?b.hasAttribute("evernote_attachment_url")?f(new Uint8Array(this.response),b,a,b.getAttribute("evernote_attachment_name"),!0):f(new Uint8Array(this.response),b,a):("embed"===b.nodeName.toLowerCase()||b.hasAttribute("evernote_attachment_url"))&&s(b),C++,t())}}(a,b);try{c.send()}catch(d){}}function r(a,b){a.bytes.length=a.byteLength,f(new Uint8Array(a.bytes),b,D.attributes.sourceURL)}function s(a){a.parentNode.removeChild(a)}function t(){if(A&&B===C){var a=new XMLSerializer;if(D.content=a.serializeToString(E),D.content.length>EDAM_NOTE_CONTENT_LEN_MAX){var c=new EDAMUserException;return c.errorCode=EDAMErrorCode.BAD_DATA_FORMAT,c.parameter="Note.content",void j(c)}if(z+=D.content.length,z>b.noteSizeMax){var c=new EDAMUserException;return c.errorCode=EDAMErrorCode.LIMIT_REACHED,c.parameter="Note.size",void j(c)}if(e({name:"showSyncing"}),"noteSizeExceeded"===extension.getOption("simulateClippingError")){var c=new EDAMUserException;c.errorCode=EDAMErrorCode.LIMIT_REACHED,c.parameter="Note.size",j(c)}else if("overQuota"===extension.getOption("simulateClippingError")){var c=new EDAMUserException;c.errorCode=EDAMErrorCode.QUOTA_REACHED,c.parameter="Accounting.uploadLimit",j(c)}else if("overAccountMax"===extension.getOption("simulateClippingError")){var c=new EDAMUserException;c.errorCode=EDAMErrorCode.LIMIT_REACHED,c.parameter="Note",j(c)}else u.createNote(F,D,k,j)}}var u,v,w,x,y,z=0,A=!1,B=0,C=0,D=new Note,E=null,F=a.submit,G=(d.submit,/^data:[^,]+,(.+)/i),H=/^resource:(.+)/i,I=["style","title","lang","xml:lang","dir","height","width","usemap","align","border","hspace","vspace","longdesc","alt"];this.createNoteWithThrift=i,Object.preventExtensions(this),o()}Object.preventExtensions(Submitter);